<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title>Go wasm</title>
  <link rel="icon" type="image/jpg" href="favicon.jpg">
</head>

<body>
  <button onclick="query()">query</button>
  <script src="facet-engine.js"></script>
  <script src="setup-data.js"></script>

  <script>
    let recordCount = 10;
    
    let queriesExecuted = 0
    let t
    let timing = {}
    let recordCountTiming = recordCount

    let records = createRecords(recordCount)


    facetEngine.load('facet-engine.wasm', function () {
      let config = {
        arrayDotNotation: "measurements",
        nameFieldDotNotation: "measurementName",
        nameMetaDotNotation: "metrics.metricName",
        valueMapDotNotation: "metrics.measurements",
      }
      console.log('init starting')
      t = new Date().getTime()
      facetEngine.initializeObjects(JSON.stringify(config), JSON.stringify(records), callbackFacets)
      timing['initialization'] = new Date().getTime() - t
      query()
    })

    function randomList(list) {
      return list[parseInt(Math.random() * list.length)];
    }
    function randomMap(map) {
      keys = Object.keys(map)
      key = randomList(keys)
      return map[key]
    }
    function randomKey(map) {
      keys = Object.keys(map)
      return randomList(keys)
    }
    function query() {
      let record = randomList(records)
      let measurement = randomList(record.measurements)
      let measurementKey = randomKey(measurement.metrics.measurements)
      let groupName = measurement.measurementName + ' (' + measurement.metrics.metricName + ')'
      let facetName = measurementKey
      t = new Date().getTime()
      facetEngine.addFilter(groupName, facetName, true, 0, false, 90)
      facetEngine.query(callbackRecords, callbackFacets)
      queriesExecuted++
      if (queriesExecuted < 3) {
        query()
      } else {
        console.log(timing)
      }
    }

    function callbackFacets(facetGroupsJson) {
      timing['callback facets (' + recordCountTiming + ')'] = new Date().getTime() - t
    }

    function callbackRecords(idsJson) {
      recordCountTiming = JSON.parse(idsJson).length
      console.log(JSON.parse(idsJson).length)
    }


  </script>
</body>

</html>